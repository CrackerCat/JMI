# JMI
**_JNI Modern Interface in C++_**

### Features

- Signature is generated by compiler only once
- getEnv() at any thread without caring about when to detach
- Support both In & Out parameters for JNI methods
- Per java class jclass cache and per method jmethodID cache
- The same C++/Java linkage: a static java member is a static member in C++


### Example:
- Setup java vm in `JNI_OnLoad`: `jmi::javaVM(vm);`

- Create a SurfaceTexture: 
```
    // define SurfaceTexture tag class in any scope visibile by jmi::JObject<SurfaceTexture>
    struct SurfaceTexture : jmi::ClassTag { static std::string name() {return "android/graphics/SurfaceTexture";}};
    ...
    GLuint tex = ...
    ...
    jmi::JObject<SurfaceTexture> texture;
    if (!texture.create(tex)) {
        // texture.error() ...
    }
```

- Create Surface from SurfaceTexture:
```
    struct Surface : jmi::ClassTag { static std::string name() {return "android.view.Surface";}}; // '.' or '/'
    ...
    jmi::JObject<Surface> surface;
    surface.create(texture);
```

- Call void method:
```
    texture.call("updateTexImage");
```

- Call method with output parameters:
```
    float mat4[16] mat4; // or std::array<float, 16>, valarray<float>
    texture.call("getTransformMatrix", std::ref(mat4)); // use std::ref() if parameter should be modified by jni method
```

- Call method with a return type:
```
    jlong t = texture.call<jlong>("getTimestamp");
```

## jmethodID Cache

`call("methodName", ....)`/`callStatic("methodName", ....)` always invokes `GetMethodID()`/`GetStaticMethodID()`. To avoid this and invoke only once for each method of a java class, use overload one `call<...MTag>(...)`, where `MTag` is a subclass of `jmi:MethodTag` implementing `static const char* name() { return "methodName";}`.

```
    // GetMethodID() will be invoked only once for each method in the scope of MethodTag subclass
    struct UpdateTexImage : jmi::MethodTag { static const char* name() {return "updateTexImage";}};
    struct GetTimestamp : jmi::MethodTag { static const char* name() {return "getTimestamp";}};
    struct GetTransformMatrix : jmi::MethodTag { static const char* name() {return "getTransformMatrix";}};
    ...
    texture.call<UpdateTexImage>();
    jlong t = texture.call<jlong, GetTimestamp>();
    texture.call<GetTransformMatrix>(std::ref(mat4)); // use std::ref() if parameter should be modified by jni method
```

### Known Issues

- If return type and first n arguments of call/call_static are the same, explicitly specifying return type and n arguments type is required

### Why JObject is a Template?
- To support per class jclass and per method jmethodID cache

#### MIT License
>Copyright (c) 2016-2017 WangBin

